<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WA Automation Dashboard</title>

  <!-- Bootstrap & AdminLTE -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/admin-lte@3.2/dist/css/adminlte.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,400i,700" rel="stylesheet">
  <link rel="stylesheet" href="style.css">

  <style>
    /* تخصيصات إضافية */
    .chat-footer {
      display: flex;
      border-top: 1px solid #ddd;
      padding: 8px;
    }
    .chat-footer input {
      flex: 1;
      margin-right: 8px;
    }
    #sessions-body {
      max-height: 500px;
      overflow-y: auto;
    }
    /* FIXED: إضافة ارتفاع للمحادثات */
    #chatMessages {
      height: 400px;
      overflow-y: auto;
      padding: 10px;
      background: #f8f9fa;
    }
  </style>
</head>
<body class="hold-transition sidebar-mini">
<div class="wrapper">

<!-- Header -->
  <nav class="main-header navbar navbar-expand navbar-white navbar-light">
    <span class="navbar-brand">WA Auto</span>
  </nav>

<!-- Layout -->
  <div class="content-wrapper p-3">
    <div class="row">
    
  <!-- Main Sidebar -->
 <div class="col-md-2"> 
   <aside class="main-sidebar sidebar-dark-primary elevation-4">
     <div class="sidebar">
       <nav class="mt-2">
        <ul class="nav nav-pills nav-sidebar flex-column" role="menu">
          <!-- FIXED: إضافة tabs للفلاتر -->
          <li class="nav-item"><a href="#" class="nav-link tab-link active" data-tab="all"><i class="fas fa-list"></i> <p>All</p></a></li>
          <li class="nav-item"><a href="#" class="nav-link tab-link " data-tab="group"><i class="fas fa-users"></i> <p>Group</p></a></li>
          <li class="nav-item"><a href="#" class="nav-link tab-link" data-tab="unread"><i class="fas fa-envelope"></i> <p>Unread</p></a></li>
          <li class="nav-item"><a href="#" class="nav-link tab-link" data-tab="unreplied"><i class="fas fa-reply"></i> <p>Unreplied</p></a></li>
          <li class="nav-item"><a href="#" id="qr-link" style="display:none;" class="nav-link"><i class="fas fa-qrcode"></i> <p>Link WhatsApp</p></a></li>
          <li class="nav-item"><a href="users.html" class="nav-link"><i class="fas fa-user-cog"></i> <p>Users</p></a></li>
          <li class="nav-item"><a href="numbers.html" class="nav-link"><i class="fas fa-hashtag"></i> <p>Numbers</p></a></li>
          <li class="nav-item"><a href="reports.html" class="nav-link"><i class="fas fa-chart-bar"></i> <p>Reports</p></a></li>
          <li class="nav-item"><a href="settings.html" class="nav-link"><i class="fas fa-cogs"></i> <p>Settings</p></a></li>
         </ul>
      </nav>
       
       <!-- FIXED: إضافة اختيار اللغة في السايدبار -->
       <div class="p-3">
        <select id="langSelect" class="form-control form-control-sm">
          <option value="en">English</option>
          <option value="ar">العربية</option>
          <option value="es">Español</option>
        </select>
      </div>
     </div>
   </aside>
 </div>
  
<!-- Clients / Sessions List -->
      <div class="col-md-3">
        <div class="card card-outline card-primary h-100">
          <div class="card-header">
            <h3 class="card-title">Clients</h3>
          </div>
          <div class="card-body p-0">
          <input type="text" id="search-clients" class="form-control mb-2" placeholder="Search clients..." oninput="applyFilters()">
          <select id="tagFilterClients" class="form-control mb-2" onchange="applyTagFilter()">
          <option value="all">All</option>
          <option value="VIP">VIP</option>
          <option value="Old">Old</option>
          <option value="Deal">Deal</option>
          <option value="Repeat">Repeat</option>
          <option value="Blacklist">Blacklist</option>
          </select>
          <ul class="list-group list-group-flush" id="sessions-body"></ul>
         </div>
        </div>
       </div>  
          
       
<!-- Chat View -->
<div class="col-md-5">
<div class="card card-outline card-success">
<div class="card-header"><h3 class="card-title">Conversation</h3></div>
<div class="card-body">
<!-- Header -->
<div class="chat-header d-flex justify-content-between align-items-center px-3" id="chatHeader">
<div>
<strong id="chatClient">Select a conversation...</strong><br>
<small id="chatStatus">Offline</small>
</div>
<div>
<i class="fas fa-search mx-2"></i>
<i class="fas fa-phone mx-2"></i>
<i class="fas fa-ellipsis-v mx-2"></i>
</div>
</div>
<!-- Messages -->
<div id="chatMessages" class="messages"></div>
<!-- Footer -->
<div class="chat-footer">
<i class="far fa-smile me-2"></i>
<input type="file" id="mediaInput" class="d-none" onchange="previewMedia(event)">
              <label for="mediaInput" class="btn btn-sm btn-outline-secondary me-2">
              <i class="fas fa-paperclip"></i>
              </label>
              <input type="text" id="msgInput" placeholder="Type a message...">
              <button onclick="if(currentSession) sendMessage(currentSession.id)">
              <i class="fas fa-paper-plane"></i>
              </button>
              </div> 
           </div>
         </div>
         <!-- 🔹 Client Details -->
         <div class="col-md-2">  
         <div class="card card-outline card-info ">
         <div class="card-header">
              <h3 class="card-title">Client Details</h3>
              </div>
              <div class="card-body">
               <p><b>Name:</b> <span id="detailName"></span></p>
               <p><b>Phone:</b> <span id="detailPhone"></span></p>
               <p><b>Tags:</b> <span id="detailTags"></span></p>
                <h6>Notes</h6>
                <textarea id="detailNote" class="form-control mb-2"></textarea>
                <button class="btn btn-primary btn-sm" onclick="saveNote()">Save Note</button>
                </div>
               <div class="theme-toggle">
        <label class="switch">
        <input type="checkbox" id="darkModeToggle" onchange="toggleDarkMode()">
        <span class="slider"></span>
        </label>
        <span>Dark Mode</span>
      </div> 
         </div>
              </div>
          </div>
        </div>
</div>

<!-- Session Count -->
<div id="session-count" class="mt-3"></div>

async function loadSessionsByRole(role, userId) {
  try {
    let res;
    if (role === "agent") {
      res = await axios.get(`/users/sessions/agent/${userId}`, { withCredentials: true });
    } else if (role === "admin" || role === "super_admin" || role === "supervisor") {
      res = await axios.get(`/users/sessions`, { withCredentials: true });
    }

    const sessions = res.data;
    const list = document.getElementById("sessions-body");
    list.innerHTML = "";
    sessions.forEach(s => {
      const li = document.createElement("li");
      li.className = "list-group-item";
      li.innerHTML = `
  <img src="${s.avatar || 'default.png'}" class="client-avatar">
  <div class="client-info">
    <div class="top">
      <span>${s.client_name || s.number}</span>
      <small>${s.last_seen || ''}</small>
    </div>
    <div class="last-msg">${s.last_message || ''}</div>
    <div class="client-tags">
      ${(s.tags || []).map(t => `<span class="tag">${t}</span>`).join('')}
    </div>
  </div>
`;
      list.appendChild(li);
    });
  } catch (err) {
    console.error("Error loading sessions", err);
  }
}
</script>

      
  </div>
  <!-- /.content-wrapper -->

</div>

<!-- Right Click Menu -->
<ul id="contextMenu" class="context-menu">
  <li onclick="transferSession()">Session transfer</li>
  <li onclick="setupGroups()">Set up groups</li>
  <li onclick="setLabel()">Set label</li>
  <li onclick="deleteTag()">Delete tag</li>
  <li onclick="blockMessaging()">Prohibit customer block messaging</li>
  <li onclick="unpinSession()">Unpinned</li>
  <li onclick="doNotDisturb()">Do not disturb</li>
  <li onclick="refreshAvatar()">Refresh avatar</li>
  <li onclick="syncMessages()">Sync phone message</li>
  <li onclick="batchOperation()">Batch operation</li>
</ul>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script> <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script> 
<script src="https://cdn.jsdelivr.net/npm/admin-lte@3.2/dist/js/adminlte.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
<script src="script.js"></script>
<script src="users.js"></script>

<!-- FIXED: تصحيح مسار ملف اللغة -->
<script src="lang.js"></script>
<script>
  // FIXED: تصحيح document.getElementById
  document.getElementById("langSelect").addEventListener("change", (e) => {
    setLanguage(e.target.value);
  });
  setLanguage("en");
</script>
  
</body>
</html>

